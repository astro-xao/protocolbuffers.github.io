<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/protocolbuffers.github.io/favicons/favicon.ico><link rel=apple-touch-icon href=/protocolbuffers.github.io/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/protocolbuffers.github.io/favicons/android-192x192.png sizes=192x192><title>API 最佳实践 | Protocol Buffers Documentation</title>
<meta name=description content="设计一个面向未来的 API 出奇地难。本文件中的建议在权衡取舍时更倾向于长期、无 bug 的演进。"><meta property="og:title" content="API 最佳实践"><meta property="og:description" content="设计一个面向未来的 API 出奇地难。本文件中的建议在权衡取舍时更倾向于长期、无 bug 的演进。"><meta property="og:type" content="article"><meta property="og:url" content="https://astro-xao.github.io/protocolbuffers.github.io/best-practices/api/"><meta property="article:section" content="best-practices"><meta itemprop=name content="API 最佳实践"><meta itemprop=description content="设计一个面向未来的 API 出奇地难。本文件中的建议在权衡取舍时更倾向于长期、无 bug 的演进。"><meta itemprop=wordCount content="1140"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="API 最佳实践"><meta name=twitter:description content="设计一个面向未来的 API 出奇地难。本文件中的建议在权衡取舍时更倾向于长期、无 bug 的演进。"><link rel=preload href=/protocolbuffers.github.io/scss/main.min.27bc098c9a8f7a1246d474f5c8afcee53760c9c7f38125d343ff52e0bf493011.css as=style integrity="sha256-J7wJjJqPehJG1HT1yK/O5TdgycfzgSXTQ/9S4L9JMBE=" crossorigin=anonymous><link href=/protocolbuffers.github.io/scss/main.min.27bc098c9a8f7a1246d474f5c8afcee53760c9c7f38125d343ff52e0bf493011.css rel=stylesheet integrity="sha256-J7wJjJqPehJG1HT1yK/O5TdgycfzgSXTQ/9S4L9JMBE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5L8P8GRN4Y"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5L8P8GRN4Y")}</script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/protocolbuffers.github.io/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Protocol Buffers Documentation</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-protocolbuffersgithubio-li><a href=/protocolbuffers.github.io/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-protocolbuffersgithubio><span>Protocol Buffers</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiooverview-li><a href=/protocolbuffers.github.io/overview/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiooverview><span>Overview</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioinstallation-li><a href=/protocolbuffers.github.io/installation/ title="Protocol Buffer Compiler Installation" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioinstallation><span>Protoc Installation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubionews-li><a href=/protocolbuffers.github.io/news/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubionews><span>News</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioprogramming-guides-li><a href=/protocolbuffers.github.io/programming-guides/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioprogramming-guides><span>Programming Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guideseditions-li><a href=/protocolbuffers.github.io/programming-guides/editions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guideseditions><span>Language Guide (editions)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesproto2-li><a href=/protocolbuffers.github.io/programming-guides/proto2/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesproto2><span>Language Guide (proto 2)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesproto3-li><a href=/protocolbuffers.github.io/programming-guides/proto3/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesproto3><span>Language Guide (proto 3)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesproto-limits-li><a href=/protocolbuffers.github.io/programming-guides/proto-limits/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesproto-limits><span>Proto Limits</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesstyle-li><a href=/protocolbuffers.github.io/programming-guides/style/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesstyle><span>Style Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesenum-li><a href=/protocolbuffers.github.io/programming-guides/enum/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesenum><span>Enum Behavior</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesencoding-li><a href=/protocolbuffers.github.io/programming-guides/encoding/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesencoding><span>Encoding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesjson-li><a href=/protocolbuffers.github.io/programming-guides/json/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesjson><span>ProtoJSON Format</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidestechniques-li><a href=/protocolbuffers.github.io/programming-guides/techniques/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidestechniques><span>Techniques</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesaddons-li><a href=/protocolbuffers.github.io/programming-guides/addons/ title="Third-Party Add-ons" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesaddons><span>Add-ons</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesextension_declarations-li><a href=/protocolbuffers.github.io/programming-guides/extension_declarations/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesextension_declarations><span>Extension Declarations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesfield_presence-li><a href=/protocolbuffers.github.io/programming-guides/field_presence/ title="Application Note: Field Presence" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesfield_presence><span>Field Presence</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesserialization-not-canonical-li><a href=/protocolbuffers.github.io/programming-guides/serialization-not-canonical/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesserialization-not-canonical><span>Proto Serialization Is Not Canonical</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioprogramming-guidesdeserialize-debug-li><a href=/protocolbuffers.github.io/programming-guides/deserialize-debug/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioprogramming-guidesdeserialize-debug><span>Deserializing Debug Proto Representations</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioeditions-li><a href=/protocolbuffers.github.io/editions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioeditions><span>Protobuf Editions</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioeditionsoverview-li><a href=/protocolbuffers.github.io/editions/overview/ title="Protobuf Editions Overview" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioeditionsoverview><span>Overview</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioeditionsfeatures-li><a href=/protocolbuffers.github.io/editions/features/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioeditionsfeatures><span>Feature Settings for Editions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioeditionsimplementation-li><a href=/protocolbuffers.github.io/editions/implementation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioeditionsimplementation><span>Implementing Editions Support</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubiodesign-decisions-li><a href=/protocolbuffers.github.io/design-decisions/ title="Protobuf Team Design Decisions" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubiodesign-decisions><span>Design Decisions</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiodesign-decisionsnullable-getters-setters-li><a href=/protocolbuffers.github.io/design-decisions/nullable-getters-setters/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiodesign-decisionsnullable-getters-setters><span>No Nullable Setters/Getters Support</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-protocolbuffersgithubiobest-practices-li><a href=/protocolbuffers.github.io/best-practices/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubiobest-practices><span>Proto 最佳实践</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiobest-practicesdos-donts-li><a href=/protocolbuffers.github.io/best-practices/dos-donts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiobest-practicesdos-donts><span>Proto 最佳实践</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiobest-practicesno-cargo-cults-li><a href=/protocolbuffers.github.io/best-practices/no-cargo-cults/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiobest-practicesno-cargo-cults><span>避免盲目跟风</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-protocolbuffersgithubiobest-practicesapi-li><a href=/protocolbuffers.github.io/best-practices/api/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiobest-practicesapi><span class=td-sidebar-nav-active-item>API 最佳实践</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiobest-practices1-1-1-li><a href=/protocolbuffers.github.io/best-practices/1-1-1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiobest-practices1-1-1><span>1-1-1 最佳实践</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubiogetting-started-li><a href=/protocolbuffers.github.io/getting-started/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubiogetting-started><span>Tutorials</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiogetting-startedcpptutorial-li><a href=/protocolbuffers.github.io/getting-started/cpptutorial/ title="Protocol Buffer Basics: C++" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiogetting-startedcpptutorial><span>C++</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiogetting-startedcsharptutorial-li><a href=/protocolbuffers.github.io/getting-started/csharptutorial/ title="Protocol Buffer Basics: C#" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiogetting-startedcsharptutorial><span>C#</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiogetting-starteddarttutorial-li><a href=/protocolbuffers.github.io/getting-started/darttutorial/ title="Protocol Buffer Basics: Dart" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiogetting-starteddarttutorial><span>Dart</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiogetting-startedgotutorial-li><a href=/protocolbuffers.github.io/getting-started/gotutorial/ title="Protocol Buffer Basics: Go" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiogetting-startedgotutorial><span>Go</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiogetting-startedjavatutorial-li><a href=/protocolbuffers.github.io/getting-started/javatutorial/ title="Protocol Buffer Basics: Java" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiogetting-startedjavatutorial><span>Java</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiogetting-startedkotlintutorial-li><a href=/protocolbuffers.github.io/getting-started/kotlintutorial/ title="Protocol Buffer Basics: Kotlin" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiogetting-startedkotlintutorial><span>Kotlin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiogetting-startedpythontutorial-li><a href=/protocolbuffers.github.io/getting-started/pythontutorial/ title="Protocol Buffer Basics: Python" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiogetting-startedpythontutorial><span>Python</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreference-li><a href=/protocolbuffers.github.io/reference/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreference><span>Reference Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencecpp-li><a href=/protocolbuffers.github.io/reference/cpp/ title="C++ Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencecpp><span>C++</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencecppcpp-generated-li><a href=/protocolbuffers.github.io/reference/cpp/cpp-generated/ title="C++ Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencecppcpp-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencecppstring-view-li><a href=/protocolbuffers.github.io/reference/cpp/string-view/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencecppstring-view><span>String View APIs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencecpparenas-li><a href=/protocolbuffers.github.io/reference/cpp/arenas/ title="C++ Arena Allocation Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencecpparenas><span>Arena Allocation Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencecppabseil-li><a href=/protocolbuffers.github.io/reference/cpp/abseil/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencecppabseil><span>Abseil Support</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencecppapi-docs-link-li><a href=/reference/cpp/api-docs/ target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencecppapi-docs-link><span>C++ API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencecsharp-li><a href=/protocolbuffers.github.io/reference/csharp/ title="C# Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencecsharp><span>C#</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencecsharpcsharp-generated-li><a href=/protocolbuffers.github.io/reference/csharp/csharp-generated/ title="C# Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencecsharpcsharp-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencecsharpapi-docs-link-li><a href=/reference/csharp/api-docs target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencecsharpapi-docs-link><span>C# API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencedart-li><a href=/protocolbuffers.github.io/reference/dart/ title="Dart Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencedart><span>Dart</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencedartdart-generated-li><a href=/protocolbuffers.github.io/reference/dart/dart-generated/ title="Dart Generated Code" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencedartdart-generated><span>Generated Code</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencedartapi-docs-link-li><a href=https://pub.dartlang.org/documentation/protobuf target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencedartapi-docs-link><span>Dart API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencego-li><a href=/protocolbuffers.github.io/reference/go/ title="Go Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencego><span>Go</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegogo-generated-li><a href=/protocolbuffers.github.io/reference/go/go-generated/ title="Go Generated Code Guide (Open)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegogo-generated><span>Generated Code Guide (Open)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegogo-generated-opaque-li><a href=/protocolbuffers.github.io/reference/go/go-generated-opaque/ title="Go Generated Code Guide (Opaque)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegogo-generated-opaque><span>Generated Code Guide (Opaque)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegofaq-li><a href=/protocolbuffers.github.io/reference/go/faq/ title="Go FAQ" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegofaq><span>FAQ</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegosize-li><a href=/protocolbuffers.github.io/reference/go/size/ title="Go Size Semantics" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegosize><span>Size Semantics</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegoapi-docs-link-li><a href=https://pkg.go.dev/google.golang.org/protobuf/proto target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegoapi-docs-link><span>Go API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegoopaque-migration-li><a href=/protocolbuffers.github.io/reference/go/opaque-migration/ title="Go Opaque API Migration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegoopaque-migration><span>Opaque API Migration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegoopaque-migration-manual-li><a href=/protocolbuffers.github.io/reference/go/opaque-migration-manual/ title="Go Opaque API: Manual Migration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegoopaque-migration-manual><span>Opaque API: Manual Migration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencegoopaque-faq-li><a href=/protocolbuffers.github.io/reference/go/opaque-faq/ title="Go Opaque API FAQ" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencegoopaque-faq><span>Opaque API FAQ</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencejava-li><a href=/protocolbuffers.github.io/reference/java/ title="Java Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencejava><span>Java</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencejavajava-generated-li><a href=/protocolbuffers.github.io/reference/java/java-generated/ title="Java Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencejavajava-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencejavajava-proto-names-li><a href=/protocolbuffers.github.io/reference/java/java-proto-names/ title="Java Proto Names" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencejavajava-proto-names><span>Generated Proto Names</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencejavaapi-docs-link-li><a href=/reference/java/api-docs/overview-summary.html target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencejavaapi-docs-link><span>Java API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencekotlin-li><a href=/protocolbuffers.github.io/reference/kotlin/ title="Kotlin Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencekotlin><span>Kotlin</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencekotlinapi-docs-li><a href=/protocolbuffers.github.io/reference/kotlin/api-docs/ title="Kotlin Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencekotlinapi-docs><span>Kotlin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencekotlinkotlin-generated-li><a href=/protocolbuffers.github.io/reference/kotlin/kotlin-generated/ title="Kotlin Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencekotlinkotlin-generated><span>Generated Code Guide</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferenceobjective-c-li><a href=/protocolbuffers.github.io/reference/objective-c/ title="Objective-C Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferenceobjective-c><span>Objective-C</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferenceobjective-cobjective-c-generated-li><a href=/protocolbuffers.github.io/reference/objective-c/objective-c-generated/ title="Objective-C Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferenceobjective-cobjective-c-generated><span>Generated Code Guide</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencephp-li><a href=/protocolbuffers.github.io/reference/php/ title="PHP Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencephp><span>PHP</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencephpphp-generated-li><a href=/protocolbuffers.github.io/reference/php/php-generated/ title="PHP Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencephpphp-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencephpapi-docs-link-li><a href=/reference/php/api-docs/ target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencephpapi-docs-link><span>PHP API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferencepython-li><a href=/protocolbuffers.github.io/reference/python/ title="Python Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferencepython><span>Python</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencepythonpython-generated-li><a href=/protocolbuffers.github.io/reference/python/python-generated/ title="Python Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencepythonpython-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencepythonapi-docs-link-li><a href=https://googleapis.dev/python/protobuf/latest/ target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencepythonapi-docs-link><span>Python API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferenceruby-li><a href=/protocolbuffers.github.io/reference/ruby/ title="Ruby Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferenceruby><span>Ruby</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferencerubyruby-generated-li><a href=/protocolbuffers.github.io/reference/ruby/ruby-generated/ title="Ruby Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferencerubyruby-generated><span>Generated Code Guide</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubioreferenceprotobuf-li><a href=/protocolbuffers.github.io/reference/protobuf/ title="Protocol Buffers Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubioreferenceprotobuf><span>Protocol Buffers</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferenceprotobufedition-2023-spec-li><a href=/protocolbuffers.github.io/reference/protobuf/edition-2023-spec/ title="Protocol Buffers Edition 2023 Language Specification" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferenceprotobufedition-2023-spec><span>2023 Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferenceprotobufproto2-spec-li><a href=/protocolbuffers.github.io/reference/protobuf/proto2-spec/ title="Protocol Buffers Version 2 Language Specification" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferenceprotobufproto2-spec><span>Version 2 Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferenceprotobufproto3-spec-li><a href=/protocolbuffers.github.io/reference/protobuf/proto3-spec/ title="Protocol Buffers Version 3 Language Specification" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferenceprotobufproto3-spec><span>Version 3 Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferenceprotobuftextformat-spec-li><a href=/protocolbuffers.github.io/reference/protobuf/textformat-spec/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferenceprotobuftextformat-spec><span>Text Format Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferenceprotobufgoogleprotobuf-li><a href=/protocolbuffers.github.io/reference/protobuf/google.protobuf/ title="Protocol Buffers Well-Known Types" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferenceprotobufgoogleprotobuf><span>Well-Known Types</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioreferenceother-li><a href=/protocolbuffers.github.io/reference/other/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioreferenceother><span>Other Languages</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-protocolbuffersgithubiosupport-li><a href=/protocolbuffers.github.io/support/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-protocolbuffersgithubiosupport><span>Support</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiosupportversion-support-li><a href=/protocolbuffers.github.io/support/version-support/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiosupportversion-support><span>Version Support</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiosupportmigration-li><a href=/protocolbuffers.github.io/support/migration/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiosupportmigration><span>Migration Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiosupportcross-version-runtime-guarantee-li><a href=/protocolbuffers.github.io/support/cross-version-runtime-guarantee/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiosupportcross-version-runtime-guarantee><span>Cross-Version Runtime Guarantee</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiodownloads-li><a href=/protocolbuffers.github.io/downloads/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiodownloads><span>Downloads</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiohistory-li><a href=/protocolbuffers.github.io/history/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiohistory><span>History</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubioforum-link-li><a href=https://groups.google.com/g/protobuf target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubioforum-link><span>Forum</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubionavbar-li><a href=/protocolbuffers.github.io/navbar/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubionavbar><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-protocolbuffersgithubiosearch-li><a href=/protocolbuffers.github.io/search/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-protocolbuffersgithubiosearch><span>Search Results</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/astro-xao/protocolbuffers.github.io//tree/main/content/best-practices/api.md class=td-page-meta--view target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/astro-xao/protocolbuffers.github.io//edit/main/content/best-practices/api.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/astro-xao/protocolbuffers.github.io//new/main/content/best-practices/api.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/astro-xao/protocolbuffers.github.io//issues/new?title=API%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" class=td-page-meta--issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/protocolbuffers/protobuf/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#precisely-concisely>精确、简明地为大多数字段和消息编写文档</a></li><li><a href=#use-different-messages>为传输和存储使用不同的消息</a></li><li><a href=#support-partial-updates>对变更操作，支持部分更新或仅追加更新，而非全量替换</a><ul><li><a href=#use-update-field-mask>方案一：使用更新字段掩码</a></li><li><a href=#expose-more-narrow-mutations>方案二：暴露更细粒度的变更方法</a></li></ul></li><li><a href=#dont-include-primitive-types>顶层请求或响应 proto 不要包含原始类型</a></li><li><a href=#never-use-booleans-for-two-states>永远不要用布尔型表示现在只有两种状态但未来可能扩展的字段</a></li><li><a href=#integer-field-for-id>很少用整型字段做 ID</a></li><li><a href=#dont-encode-data-in-a-string>不要将需要客户端构造或解析的数据编码为字符串</a><ul><li><a href=#returning-html>不要在前端 proto 返回 HTML</a></li></ul></li><li><a href=#encode-opaque-data-in-strings>通过 Web 安全编码二进制 proto 序列化将不透明数据编码为字符串</a></li><li><a href=#dont-include-fields>不要包含客户端不可能用到的字段</a></li><li><a href=#define-pagination-api><em>极少</em>定义没有续页 token 的分页 API</a></li><li><a href=#group-related-fields>将相关字段分组为新 message，仅对高内聚字段嵌套</a></li><li><a href=#include-field-read-mask>在读取请求中包含字段读取掩码</a></li><li><a href=#include-version-field>在读取请求中包含版本字段以实现一致性读取</a></li><li><a href=#use-consistent-request-options>对返回相同数据类型的 RPC 使用一致的请求选项</a></li><li><a href=#batch-multi-phase-requests>批量/多阶段请求</a></li><li><a href=#create-methods-manipulate-small-bits>创建返回或操作小数据块的方法，鼓励客户端批量组合请求</a></li><li><a href=#make-one-off-rpc>当移动或 Web 客户端需串行往返时，创建一次性 RPC</a></li><li><a href=#repeated-fields-messages-scalar-types>repeated 字段应为消息类型，而非标量或枚举</a></li><li><a href=#use-proto-maps>使用 Proto Map</a></li><li><a href=#prefer-idempotency>优先保证幂等性</a></li><li><a href=#service-name-globally-unique>注意服务名，确保全局唯一</a></li><li><a href=#bound-req-res-sizes>限定请求和响应大小</a></li><li><a href=#propagate-status-codes>谨慎传播状态码</a></li><li><a href=#unique-protos>每个方法创建唯一的 proto</a><ul><li><a href=#reuse-messages>复用消息</a></li></ul></li><li><a href=#appendix>附录</a><ul><li><a href=#returning-repeated-fields>返回 repeated 字段</a></li><li><a href=#updating-repeated-fields>更新 repeated 字段</a></li><li><a href=#order-independence-repeated-fields>repeated 字段的顺序无关性</a></li><li><a href=#leaking-features>因 proto 被打包进移动端导致功能泄露</a></li><li><a href=#performance-optimizations>性能优化</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/protocolbuffers.github.io/best-practices/>Proto 最佳实践</a></li><li class="breadcrumb-item active" aria-current=page>API 最佳实践</li></ol></nav><div class=td-content><h1>API 最佳实践</h1><div class=lead>设计一个面向未来的 API 出奇地难。本文件中的建议在权衡取舍时更倾向于长期、无 bug 的演进。</div><header class=article-meta></header><p>已针对 proto3 更新。欢迎补丁！</p><p>本文档是
<a href=./best-practices/dos-donts>Proto 最佳实践</a> 的补充。
它不是针对 Java/C++/Go 及其他 API 的规定。</p><p>如果你在代码评审中发现 proto 偏离了这些指南，请将作者指向本主题，帮助传播最佳实践。</p><div class="alert alert-note" role=alert><h4 class=alert-heading>注意</h4>这些指南仅供参考，且许多有明确的例外。例如，如果你在编写性能关键的后端，可能会为了速度牺牲灵活性或安全性。本主题将帮助你更好地理解权衡，并做出适合你场景的决策。</div><h2 id=precisely-concisely>精确、简明地为大多数字段和消息编写文档</h2><p>你的 proto 很可能会被不了解你设计初衷的人继承和使用。请用对新团队成员或客户有用的术语为每个字段编写文档。</p><p>具体示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 错误：启用 Foo 的选项
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 正确：控制 Foo 功能行为的配置。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FeatureFooConfig</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：设置是否启用该功能
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 正确：必填字段，指示是否为 account_id 启用 Foo 功能。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 如果 account_id 的 FOO_OPTIN Gaia 位未设置，必须为 false。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>enabled</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// 错误：Foo 对象。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 正确：API 中面向客户端的 Foo（what/foo）表示。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：foo 的标题。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 正确：表示用户提供的 Foo 标题，无归一化或转义。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 示例标题：&#34;Picture of my cat in a box &lt;3 &lt;3 !!!&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>title</span> <span style=color:#000;font-weight:700>[(</span><span style=color:#000>max_length</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>512</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// 错误：Foo 配置。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 不如不写：如果最有用的注释只是重复字段名，最好省略注释。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>FooConfig</span> <span style=color:#000>foo_config</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>用尽量少的文字描述每个字段的约束、期望和解释。</p><p>你可以使用自定义 proto 注解。
参见 <a href=./programming-guides/proto2#options>自定义选项</a>
以定义跨语言常量，如上例中的 <code>max_length</code>。
proto2 和 proto3 均支持。</p><p>接口文档会随着时间变长，影响清晰度。文档不清时要修正，但要整体把握，追求简洁。</p><h2 id=use-different-messages>为传输和存储使用不同的消息</h2><p>如果你暴露给客户端的顶层 proto 与存储在磁盘上的 proto 相同，未来会很麻烦。依赖 API 的二进制文件会越来越多，修改难度加大。你需要有更改存储格式而不影响客户端的自由。将代码分层，让模块只处理客户端 proto、存储 proto 或转换。</p><p>原因：你可能想更换底层存储系统，或以不同方式归一化/反归一化数据，或发现部分客户端 proto 适合存储在内存，部分适合磁盘。</p><p>对于嵌套在顶层请求或响应中的 proto，是否分离存储和传输 proto 取决于你愿意让客户端与这些 proto 紧密耦合的程度。</p><p>维护转换层有成本，但一旦有客户端并需要做存储变更，很快就能收回成本。</p><p>你可能会想“等需要时再分离”。但分离成本高、内部字段无处可加时，API 会积累客户端不理解或无意中依赖的字段。</p><p>从一开始就用不同的 proto 文件，团队就知道内部字段加在哪里，不会污染 API。早期，传输 proto 可以与存储 proto 完全一致，自动转换（如字节拷贝或 proto 反射）。proto 注解也可驱动自动转换。</p><p>以下情况可例外：</p><ul><li><p>字段为常用类型，如 <code>google.type</code> 或 <code>google.protobuf</code>，可同时用作存储和 API。</p></li><li><p>服务极度性能敏感时，可为速度牺牲灵活性。若服务 QPS 没有百万级、延迟没到毫秒级，通常不属于例外。</p></li><li><p>满足以下全部条件：</p><ul><li>服务本身就是存储系统</li><li>系统不基于客户端结构化数据做决策</li><li>系统仅按客户端请求存储、加载、查询</li></ul><p>如果你实现的是日志系统或基于 proto 的通用存储包装器，建议让客户端消息尽可能透明地进入存储后端，避免依赖集中。可考虑用扩展或<a href=./best-practices/api#encode-opaque-data-in-strings>通过 Web 安全编码二进制 proto 序列化将不透明数据编码为字符串</a>。</p></li></ul><h2 id=support-partial-updates>对变更操作，支持部分更新或仅追加更新，而非全量替换</h2><p>不要让 <code>UpdateFooRequest</code> 只接收一个 <code>Foo</code>。</p><p>如果客户端不保留未知字段，<code>GetFooResponse</code> 的最新字段会丢失，导致数据丢失。有些系统不保留未知字段。proto2 和 proto3 实现会保留，除非应用显式丢弃。一般来说，公共 API 应在服务端丢弃未知字段，防止安全攻击。例如，垃圾未知字段可能导致服务器在未来使用新字段时失败。</p><p>没有文档时，可选字段的处理是模糊的。<code>UpdateFoo</code> 会清除字段吗？这会导致客户端不知字段时数据丢失。不触碰字段？那客户端如何清除字段？都不好。</p><h3 id=use-update-field-mask>方案一：使用更新字段掩码</h3><p>让客户端传递要修改的字段，并在更新请求中只包含这些字段。服务器只更新掩码指定的字段，其他字段保持不变。
掩码结构应与响应 proto 结构一致；如 <code>Foo</code> 包含 <code>Bar</code>，则 <code>FooMask</code> 包含 <code>BarMask</code>。</p><h3 id=expose-more-narrow-mutations>方案二：暴露更细粒度的变更方法</h3><p>例如，不用 <code>UpdateEmployeeRequest</code>，而用：
<code>PromoteEmployeeRequest</code>、<code>SetEmployeePayRequest</code>、<code>TransferEmployeeRequest</code> 等。</p><p>自定义更新方法更易监控、审计和安全，也更易实现和调用。<em>太多</em>会增加 API 认知负担。</p><h2 id=dont-include-primitive-types>顶层请求或响应 proto 不要包含原始类型</h2><p>本文件其他地方描述的许多陷阱都可通过此规则避免。例如：</p><p>让客户端区分存储中未设置的 repeated 字段和本次调用未填充，可通过将 repeated 字段包裹在消息中实现。</p><p>通用请求选项自然会因遵循此规则而出现。读写字段掩码也是如此。</p><p>顶层 proto 应几乎总是作为其他消息的容器，以便独立扩展。</p><p>即使现在只需一个原始类型，用消息包裹也便于后续扩展和复用。例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MultiplicationResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：如果以后要返回复数，且 AdditionResponse 也返回同类型，怎么办？
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 正确：其他方法可复用此类型，且可随服务新增功能（单位、置信区间等）扩展。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>NumericResult</span> <span style=color:#000>result</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>NumericResult</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>real_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>complex_value</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>UnitType</span> <span style=color:#000>units</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>顶层原始类型的例外：仅在字符串（或字节）编码 proto，且仅在服务器端构建和解析时可用。续页 token、版本信息 token 和 ID 可作为字符串返回，<em>前提是</em>字符串实际是结构化 proto 的编码。</p><h2 id=never-use-booleans-for-two-states>永远不要用布尔型表示现在只有两种状态但未来可能扩展的字段</h2><p>如果用布尔型字段，确保它描述的确实是仅有的两种状态（永远如此，而非现在或近期）。通常，枚举、整型或消息的灵活性更值得。</p><p>例如，返回帖子流时，开发者可能需要根据 UX 当前设计指示帖子是否双栏显示。虽然现在只需布尔型，但未来 UX 可能引入两行、三栏、四宫格等。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GooglePlusPost</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：是否双栏显示此帖子。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>big_post</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 正确：客户端显示此帖子的渲染提示。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// 客户端应据此决定如何突出显示帖子。缺省时假定默认渲染。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>LayoutConfig</span> <span style=color:#000>layout_config</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Photo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：是否为 GIF。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>gif</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 正确：照片的文件格式（如 GIF、WebP、PNG）。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>PhotoType</span> <span style=color:#000>type</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>为枚举添加新状态时要小心，避免混淆概念。</p><p>如果新状态引入了新的维度或暗示多种行为，几乎肯定需要另一个字段。</p><h2 id=integer-field-for-id>很少用整型字段做 ID</h2><p>用 int64 作为对象标识符很诱人。建议用字符串。</p><p>这样可在需要时更改 ID 空间，减少冲突风险。2^64 已不再那么大。</p><p>你也可以将结构化标识符编码为字符串，鼓励客户端将其视为不透明数据。仍需有 proto 支撑字符串，但可将 proto 序列化为字符串字段（Web 安全 Base64 编码），避免内部细节暴露给客户端。此时请遵循<a href=#encode-opaque-data-in-strings>下文</a>的指南。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GetFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 要获取的 Foo。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// 序列化并 Web 安全 base64 编码到 GetFooRequest.foo_id 字段。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>InternalFooRef</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 只设置其中一个。已迁移的 Foo 用 spanner_foo_id，未迁移的用 classic_foo_id。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bytes</span> <span style=color:#000>spanner_foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>classic_foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>如果你用自定义序列化方案将 ID 表示为字符串，后续会变得很混乱。因此，最好从一开始就用内部 proto 支撑字符串字段。</p><h2 id=dont-encode-data-in-a-string>不要将需要客户端构造或解析的数据编码为字符串</h2><p>这样做传输效率低，proto 使用者负担重，文档阅读者困惑。客户端还要考虑编码方式：列表是否逗号分隔？不可信数据是否正确转义？数字是十进制吗？最好让客户端发送实际消息或原始类型。这样更紧凑、清晰。</p><p>当服务有多语言客户端时尤其糟糕。每个客户端都要选合适的解析器或构造器，甚至自己写。</p><p>更一般地，选择合适的原始类型。参见
<a href=./programming-guides/proto2#scalar>协议缓冲区语言指南</a>中的标量值类型表。</p><h3 id=returning-html>不要在前端 proto 返回 HTML</h3><p>有 JavaScript 客户端时，容易在 API 字段中返回 HTML 或 JSON。这会让 API 与特定 UI 绑定，带来三大风险：</p><ul><li>“临时”非 Web 客户端会解析 HTML 或 JSON 获取数据，格式变更会导致脆弱性，解析不当还会有安全漏洞。</li><li>Web 客户端若返回未清理的 HTML，容易遭受 XSS 攻击。</li><li>返回的标签和类依赖特定样式表和 DOM 结构。版本变更时，结构可能变化，导致旧客户端无法正确渲染新 HTML。对于频繁发布的项目，这不是边缘情况。</li></ul><p>除首次页面加载外，通常应返回数据，由客户端模板生成 HTML。</p><h2 id=encode-opaque-data-in-strings>通过 Web 安全编码二进制 proto 序列化将不透明数据编码为字符串</h2><p>如果你在客户端可见字段中编码<em>不透明</em>数据（如续页 token、序列化 ID、版本信息等），请注明客户端应将其视为不透明数据。*始终使用二进制 proto 序列化，不要用文本格式或自定义方案。*当你需要扩展不透明字段的数据时，如果不用 proto 序列化，最终会重造轮子。</p><p>定义内部 proto 保存要放入不透明字段的内容（即使只需一个字段），序列化为字节后 Web 安全 base64 编码到字符串字段。</p><p>极少数情况下，为了极致紧凑性可用自定义格式。</p><h2 id=dont-include-fields>不要包含客户端不可能用到的字段</h2><p>API 只应描述如何与系统交互。包含其他内容只会增加理解负担。</p><p>过去常在响应 proto 返回调试数据，但现在有更好的做法。RPC 响应扩展（也叫“侧信道”）允许用一个 proto 描述客户端接口，另一个描述调试接口。</p><p>同样，过去为日志方便在响应 proto 返回实验名，约定客户端在后续操作中带回。现在推荐在分析流水线做日志关联。</p><p>例外：</p><p>如果你需要实时分析且机器预算有限，日志关联代价高，提前反规范化日志数据可能有利。如果需要让日志数据回传，作为不透明数据发送给客户端，并注明请求和响应字段。</p><p><strong>注意：</strong> 如果每次请求都要返回或回传隐藏数据，说明你在隐藏服务的真实成本，这也不好。</p><h2 id=define-pagination-api><em>极少</em>定义没有续页 token 的分页 API</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooQuery</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：数据在两次查询间变化时，这些策略会导致漏结果。在最终一致性存储（如 Bigtable）下，旧数据可能在新数据后出现。偏移和分页都假定有排序，降低灵活性。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>max_timestamp_ms</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>result_offset</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_number</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>page_size</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 正确：灵活！在 FooQueryResponse 返回此字段，客户端下次查询时传回。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>next_page_token</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>分页 API 最佳实践是用不透明续页 token（next_page_token），由内部 proto 支撑，序列化后用 <code>WebSafeBase64Escape</code>（C++）或 <code>BaseEncoding.base64Url().encode</code>（Java）编码。内部 proto 可包含多个字段，关键是带来灵活性，并可为客户端带来结果稳定性。</p><p>不要忘记将此 proto 字段视为不可信输入做校验（见<a href=#encode-opaque-data-in-strings>不透明数据编码为字符串</a>）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>InternalPaginationToken</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 跟踪已见 ID，完美召回但 token 变大，尤其是用户回翻时。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>FooRef</span> <span style=color:#000>seen_ids</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 类似 seen_ids，但用 Bloom filter 节省字节，牺牲精度。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bytes</span> <span style=color:#000>bloom_filter</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 合理的初步方案，后续可变更而不影响客户端。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000>max_timestamp_ms</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=group-related-fields>将相关字段分组为新 message，仅对高内聚字段嵌套</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：Foo 的价格和货币。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>price</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>CurrencyType</span> <span style=color:#000>currency</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 更好：封装 Foo 的价格和货币。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>CurrencyAmount</span> <span style=color:#000>price</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>只嵌套高内聚字段。如果字段确实相关，通常会一起在服务端传递，定义在一起更方便。例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>CurrencyAmount</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>calculateLocalTax</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>CurrencyAmount</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>price</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Location</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>where</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>如果你的 CL 引入一个字段，且未来可能有相关字段，预先放入独立 message，避免如下情况：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 已弃用！请用 currency_amount。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>price</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// Foo 的价格和货币。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>google.type.Money</span> <span style=color:#000>currency_amount</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>嵌套 message 的问题在于，<code>CurrencyAmount</code> 可能在 API 其他地方复用，但 <code>Foo.CurrencyAmount</code> 不便复用。最坏情况下，<code>Foo.CurrencyAmount</code> 被复用，但混入了 Foo 特有字段。</p><p>虽然<a href=https://en.wikipedia.org/wiki/Loose_coupling>松耦合</a>
通常是系统开发最佳实践，但设计 <code>.proto</code> 文件时未必适用。有时将两个信息单元紧耦合（嵌套）更合理。例如，当前看似通用的字段，未来可能加专用字段，嵌套可阻止他人随意复用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Photo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：PhotoMetadata 可能在 Photo 之外复用，最好不要嵌套，便于访问。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoMetadata</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>width</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>height</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>PhotoMetadata</span> <span style=color:#000>metadata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooConfiguration</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 正确：在 FooConfiguration 范围外复用 Rule 会导致与无关组件紧耦合，嵌套可避免。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Rule</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>float</span> <span style=color:#000>multiplier</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Rule</span> <span style=color:#000>rules</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=include-field-read-mask>在读取请求中包含字段读取掩码</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 推荐：使用 google.protobuf.FieldMask
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// 方案一：
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooReadMask</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>return_field1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>return_field2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// 方案二：
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BarReadMask</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 要返回的 Bar 字段的 tag 编号。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>fields_to_return</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>如用推荐的 <code>google.protobuf.FieldMask</code>，可用
<code>FieldMaskUtil</code>
(<a href=./reference/java/api-docs/com/google/protobuf/util/FieldMaskUtil.html>Java</a>/<a href=./reference/cpp/api-docs/google.protobuf.util.field_mask_util.md>C++</a>)
库自动过滤 proto。</p><p>读取掩码让客户端明确期望，控制返回数据量，后端也可只取所需数据。</p><p>可接受的替代方案是始终填充所有字段，即隐式读取掩码全为 true。proto 变大后代价高。</p><p>最糟糕的是隐式（未声明）读取掩码，随方法不同而变化。此反模式会导致客户端用响应 proto 构建本地缓存时出现数据丢失。</p><h2 id=include-version-field>在读取请求中包含版本字段以实现一致性读取</h2><p>客户端写后紧跟读同一对象时，期望读到刚写的数据——即使底层存储不保证。</p><p>服务器会读取本地值，若本地 version_info 小于期望值，则从远程副本读取最新值。通常 version_info 是
<a href=#encode-opaque-data-in-strings>proto 编码为字符串</a>，包含变更数据中心和提交时间戳。</p><p>即使底层存储一致，通常也希望用 token 触发更昂贵的一致性读取，而不是每次都走一致性路径。</p><h2 id=use-consistent-request-options>对返回相同数据类型的 RPC 使用一致的请求选项</h2><p>一个失败模式是：服务的每个 RPC 都返回相同数据类型，但请求选项各自为政，如最大评论数、支持的嵌入类型等。</p><p>这种做法会增加客户端填写请求的复杂度，也增加服务端将 N 个请求选项转换为统一内部选项的复杂度。许多实际 bug 都源于此。</p><p>更好的做法是：创建单独的消息保存请求选项，并在每个顶层请求消息中包含。例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 字段级读取掩码。只返回请求的字段。客户端应只请求所需字段，帮助后端优化。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooReadMask</span> <span style=color:#000>read_mask</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 每个 Foo 返回的评论数上限。被标记为垃圾的评论不计入。默认不返回评论。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>int</span> <span style=color:#000>max_comments_to_return</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 不在此支持类型列表中的嵌入会被降级为列表中的嵌入。未指定则不返回嵌入。无法降级的也不返回。强烈建议客户端始终包含 EmbedTypes.proto 的 THING_V2。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EmbedType</span> <span style=color:#000>embed_supported_types_list</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>GetFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 要读取的 Foo。无权限或已删除则响应为空但成功。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>foo_id</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 客户端必须包含此字段。为空则服务器返回 INVALID_ARGUMENT。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000>params</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>ListFooRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 要返回哪些 Foo。搜索保证 100% 召回，但条件越多性能越差。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooQuery</span> <span style=color:#000>query</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 客户端必须包含此字段。为空则服务器返回 INVALID_ARGUMENT。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FooRequestOptions</span> <span style=color:#000>params</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=batch-multi-phase-requests>批量/多阶段请求</h2><p>尽量让变更操作原子化。更重要的是让
<a href=#prefer-idempotency>变更操作幂等</a>。部分失败重试不应导致数据损坏或重复。</p><p>有时为性能需单个 RPC 封装多操作。部分失败时怎么办？最好让客户端知晓成功和失败详情。</p><p>可将 RPC 标记为失败，并在 RPC 状态 proto 中返回成功和失败详情。</p><p>总之，未了解部分失败处理的客户端应能正确工作，了解的客户端可获得更多价值。</p><h2 id=create-methods-manipulate-small-bits>创建返回或操作小数据块的方法，鼓励客户端批量组合请求</h2><p>允许客户端在一次往返中查询多个小数据块，可在不改服务器的情况下支持更多 UX 选项。</p><p>这对前端和中间层服务器尤为重要。</p><p>许多服务都暴露了自己的批量 API。</p><h2 id=make-one-off-rpc>当移动或 Web 客户端需串行往返时，创建一次性 RPC</h2><p>当<em>Web 或移动</em>客户端需做两次有数据依赖的查询时，最佳实践是创建新 RPC，避免多次往返。</p><p>对移动端，几乎总是值得将两个服务方法合并为一个，节省一次往返。对服务间调用，则视性能敏感度和新方法带来的认知负担而定。</p><h2 id=repeated-fields-messages-scalar-types>repeated 字段应为消息类型，而非标量或枚举</h2><p>常见演进是单一 repeated 字段需变为多个相关 repeated 字段。若一开始用 repeated 原始类型，后续只能用并行 repeated 字段，或新建 repeated 消息字段并迁移客户端。</p><p>若一开始用 repeated 消息，演进就很简单。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 描述应用于照片的增强类型
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EnhancementType</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>ENHANCEMENT_TYPE_UNSPECIFIED</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>RED_EYE_REDUCTION</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#000>SKIN_SOFTENING</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoEnhancement</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>EnhancementType</span> <span style=color:#000>type</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PhotoEnhancementReply</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 正确：PhotoEnhancement 可扩展描述更多字段。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>PhotoEnhancement</span> <span style=color:#000>enhancements</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：若需返回增强参数，只能用并行数组（很糟）或弃用此字段并引入 repeated 消息。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EnhancementType</span> <span style=color:#000>enhancement_types</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>假设有新需求：“我们需要知道哪些增强是用户操作，哪些是系统自动应用。”</p><p>若 <code>PhotoEnhancementReply</code> 的 enhancement 字段是标量或枚举，支持起来会很难。</p><p>map 也一样。若值已是消息类型，后续加字段更容易；否则要从 <code>map&lt;string, string></code> 迁移到 <code>map&lt;string, MyProto></code>。</p><p>例外：</p><p>对延迟极敏感的应用，原始类型并行数组比消息数组更快、更省空间（用 <a href=./programming-guides/encoding#packed>[packed=true]</a> 可省略字段标签）。分配固定数量数组比分配 N 个消息更省事。
<a href=./programming-guides/proto3>Proto3</a> 默认打包，无需显式指定。</p><h2 id=use-proto-maps>使用 Proto Map</h2><p>在
<a href=./programming-guides/proto3>Proto3</a> 引入
<a href=./programming-guides/proto3#maps>Proto3 map</a> 前，服务常用 KVPair 消息配合标量字段表示数据。后续客户端需更深结构时，只能解析 key 或 value。参见
<a href=#dont-encode-data-in-a-string>不要将数据编码为字符串</a>。</p><p>用（可扩展的）消息类型做 value 立刻优于原始设计。</p><p>map 已回移植到 proto2，故用 <code>map&lt;scalar, **message**></code> 比自造 KVPair 更好<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。</p><p>若需表示<em>任意</em>未知结构的数据，用
<a href=./reference/protobuf/textformat-spec#any><code>google.protobuf.Any</code></a>。</p><h2 id=prefer-idempotency>优先保证幂等性</h2><p>调用栈上方可能有重试逻辑。若重试是变更操作，用户可能遇到重复评论、构建请求、编辑等问题。</p><p>避免重复写入的简单方法是允许客户端指定请求 ID，服务器去重（如内容哈希或 UUID）。</p><h2 id=service-name-globally-unique>注意服务名，确保全局唯一</h2><p>服务名（即 <code>.proto</code> 文件中 <code>service</code> 关键字后的部分）用途远超生成服务类名。</p><p>问题在于，许多工具假定服务名在网络中唯一，且用<em>非限定</em>服务名（如 <code>MyService</code>），而非限定名（如 <code>my_package.MyService</code>）。</p><p>因此，即使服务定义在特定包内，也要防止命名冲突。例如，<code>Watcher</code> 可能引发问题，<code>MyProjectWatcher</code> 更好。</p><h2 id=bound-req-res-sizes>限定请求和响应大小</h2><p>请求和响应大小应有限制。
推荐上限约 8 MiB，2 GiB 是许多 proto 实现的硬限制。
许多存储系统也有限制。</p><p>否则会：</p><ul><li>增大客户端和服务器负担，</li><li>导致高且不可预测的延迟，</li><li>降低弹性，因依赖单客户端与单服务器的长连接。</li></ul><p>限定 API 消息大小的几种方式：</p><ul><li>定义返回有界消息的 RPC，每次调用逻辑独立。</li><li>定义只操作单对象的 RPC，避免操作无界对象列表。</li><li>避免在 string、bytes 或 repeated 字段中编码无界数据。</li><li>定义长时间运行操作，将结果存储在可扩展并发读取的存储系统。</li><li>用分页 API（见<a href=#define-pagination-api>分页 API</a>）。</li><li>用流式 RPC。</li></ul><p>如为 UI 开发，也请参见
<a href=#create-methods-manipulate-small-bits>创建返回或操作小数据块的方法</a>。</p><h2 id=propagate-status-codes>谨慎传播状态码</h2><p>RPC 服务应在 RPC 边界仔细检查错误，并向调用者返回有意义的状态错误。</p><p>举例说明：</p><p>假设客户端调用 <code>ProductService.GetProducts</code>，无参数。<code>GetProducts</code> 可能获取所有产品，并为每个产品调用 <code>LocaleService.LocaliseNutritionFacts</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>digraph toy_example {
</span></span><span style=display:flex><span>  node [style=filled]
</span></span><span style=display:flex><span>  client [label=&#34;Client&#34;];
</span></span><span style=display:flex><span>  product [label=&#34;ProductService&#34;];
</span></span><span style=display:flex><span>  locale [label=&#34;LocaleService&#34;];
</span></span><span style=display:flex><span>  client -&gt; product [label=&#34;GetProducts&#34;]
</span></span><span style=display:flex><span>  product -&gt; locale [label=&#34;LocaliseNutritionFacts&#34;]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>若 <code>ProductService</code> 实现错误，可能向 <code>LocaleService</code> 传错参数，导致 <code>INVALID_ARGUMENT</code>。</p><p>若 <code>ProductService</code> 粗心地将错误返回给调用者，客户端会收到 <code>INVALID_ARGUMENT</code>，但客户端并未向 <code>GetProducts</code> 传参。此错误毫无意义，只会引发混乱！</p><p>正确做法是：<code>ProductService</code> 应在 RPC 边界检查错误。若<em>收到</em>无效参数，应返回 <code>INVALID_ARGUMENT</code>。若<em>下游</em>收到无效参数，应将 <code>INVALID_ARGUMENT</code> 转为 <code>INTERNAL</code> 再返回。</p><p>错误传播不当会导致难以调试的混乱，甚至导致所有服务都转发客户端错误而无告警，形成“隐形故障”。</p><p>总之，在 RPC 边界要仔细检查错误，向调用者返回有意义的状态码。每个 RPC 方法应文档化其错误码及触发条件，方法实现应符合 API 合同。</p><h2 id=unique-protos>每个方法创建唯一的 proto</h2><p>每个 RPC 方法都应有唯一的请求和响应 proto。后续若需分离顶层请求或响应，代价很高。包括“空”响应；应创建唯一的空响应 proto，而非复用<a href=https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/empty.proto>知名 Empty 消息类型</a>。</p><h3 id=reuse-messages>复用消息</h3><p>如需复用消息，创建共享的“领域”消息类型，在多个请求和响应 proto 中包含。应用逻辑应基于这些类型，而非请求/响应类型。</p><p>这样可独立演进方法请求/响应类型，同时复用逻辑子单元代码。</p><h2 id=appendix>附录</h2><h3 id=returning-repeated-fields>返回 repeated 字段</h3><p>当 repeated 字段为空时，客户端无法区分是服务器未填充还是数据本为空。即 repeated 字段没有 <code>hasFoo</code> 方法。</p><p>用消息包裹 repeated 字段即可获得 hasFoo 方法。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>FooList</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>Foo</span> <span style=color:#000>foos</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>更全面的解决方案是用字段
<a href=#include-field-read-mask>读取掩码</a>。若请求了该字段，空列表表示无数据；未请求则客户端应忽略响应中的字段。</p><h3 id=updating-repeated-fields>更新 repeated 字段</h3><p>最糟糕的做法是强制客户端提供替换列表。这样会导致多种问题：不保留未知字段的客户端会丢数据；并发写入会丢数据。即使没有这些问题，客户端也需仔细阅读文档以理解服务器如何解释字段。空字段是表示不更新还是清空？</p><p><strong>方案一</strong>：用 repeated 更新掩码，允许客户端替换、删除或插入元素，无需提供完整数组。</p><p><strong>方案二</strong>：在请求 proto 中创建单独的追加、替换、删除数组。</p><p><strong>方案三</strong>：只允许追加或清空。可用消息包裹 repeated 字段。消息存在但为空表示清空，否则有元素表示追加。</p><h3 id=order-independence-repeated-fields>repeated 字段的顺序无关性</h3><p><em>尽量</em>避免顺序依赖。顺序依赖增加脆弱性。尤其是并行数组，客户端难以解释结果，服务端传递相关字段也不自然。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BatchEquationSolverResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 错误：解的顺序与请求方程顺序一致。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_values</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// （通常）错误：solved_values 的并行数组。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_complex_values</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// 正确：单独消息可扩展，且可被其他方法复用。请求与响应间、多个 repeated 字段间无顺序依赖。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>BatchEquationSolverResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 已弃用，Q2 2014 前继续填充，之后客户端必须用 solutions 字段。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>double</span> <span style=color:#000>solved_values</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>deprecated</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>];</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 正确：请求中每个方程有唯一标识符，EquationSolution 中包含，便于关联。方程并行求解，解生成后加入数组。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>EquationSolution</span> <span style=color:#000>solutions</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=leaking-features>因 proto 被打包进移动端导致功能泄露</h3><p>Android 和 iOS 运行时都支持反射。为此，字段和消息的未过滤名称会作为字符串嵌入应用二进制（APK、IPA）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>Foo</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#8f5902;font-style:italic>// 这会在 Android 和 iOS 泄露 Google Teleport 项目存在
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>FeatureStatus</span> <span style=color:#000>google_teleport_enabled</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>几种缓解策略：</p><ul><li>Android 用 ProGuard 混淆。iOS 无混淆选项：拿到 IPA 后用 <code>strings</code> 就能看到字段名。
<a href=https://github.com/Bensge/Chrome-for-iOS-Headers>iOS Chrome 拆包</a></li><li>精确筛选发送到移动端的字段。</li><li>若无法及时堵住泄露，与功能所有者达成风险共识。</li></ul><p><em>绝不要</em>用代号混淆字段含义。要么堵住泄露，要么获得风险共识。</p><h3 id=performance-optimizations>性能优化</h3><p>有时可为性能牺牲类型安全或清晰度。例如，含数百字段（尤其是消息字段）的 proto 解析慢，深层嵌套消息仅因内存管理也慢。加速反序列化的常用技巧：</p><ul><li>创建并行精简 proto，镜像大 proto 但只声明部分标签。解析时只用精简 proto。加测试确保标签号一致。</li><li>用
<a href=https://github.com/protocolbuffers/protobuf/blob/cacb096002994000f8ccc6d9b8e1b5b0783ee561/src/google/protobuf/descriptor.proto#L609>[lazy=true]</a>
注解字段为“延迟解析”。</li><li>声明字段为 bytes 并注明类型。关心的客户端可手动解析。风险是无法防止放错类型的消息。写入日志的 proto 切勿用此法，否则无法检查 PII 或做策略/隐私清理。</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>proto 中含 <code>map&lt;k,v></code> 字段时，不要用作 MapReduce 的 reduce key。proto3 map 项的线性化和迭代顺序<em>未定义</em>，会导致 map 分片不一致。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel=noopener href=https://stackoverflow.com/questions/tagged/protocol-buffers aria-label="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=50px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#ffb data-fg=#000 data-position=bottom data-padding="10px 16px" data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/protocolbuffers/protobuf aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/protobuf aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=50px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#ffb data-fg=#000 data-position=bottom data-padding="10px 16px" data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2025 Google LLC All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small>
<span class=text-white>Hosted by GitHub Pages.</span> <a href=https://docs.github.com/en/site-policy/privacy-policies/github-privacy-statement target=_blank>GitHub Privacy Statement</a></div></div></div></footer></div><script src=/protocolbuffers.github.io/js/main.min.465e525b7f12005beca2f93e7a2facf1d7da354d8fa99daffa84ddbfba25da98.js integrity="sha256-Rl5SW38SAFvsovk+ei+s8dfaNU2PqZ2v+oTdv7ol2pg=" crossorigin=anonymous></script><script defer src=/protocolbuffers.github.io/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/protocolbuffers.github.io/js/tabpane-persist.js></script></body></html>